<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GSoC'24 Journey: singul4ri7y</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <content>
        <header class="header">
            <h1>My GSoC'24 Journey</h1>
            <div class="misc">
                <div class="links">
                    <a href="https://linkedin.com/in/singul4ri7y" target="_blank" title="LinkedIn">
                        <i class="fab fa-linkedin"></i>
                    </a>
                    <a href="https://github.com/singul4ri7y" target="_blank" title="GitHub">
                        <i class="fab fa-github"></i>
                    </a>
                </div>
                <div class="date">24th August, 2024</div>
                <div class="switch">
                    <input id="switch" class="switch__input" name="switch" type="checkbox">
                    <label class="switch__label" for="switch"></label>
                </div>
            </div>
        </header>

        <main>
            <div class="main-content">
                <p>Ahh, who could&#39;ve thought? I spent my entire summer coding away as part of <a href="summerofcode.withgoogle.com">Google Summer of Code</a>! Feels like the summer just began yesterday.</p>

                <h2 id="prologue">Prologue</h2>
                <p>Konnichiwa, I&#39;m Syed Naimul Hasan Asif (alias SD Asif Hossein), an Electrical Engineering undergrad student from Bangladesh who is passionate about low-level programming, programming language research, operating systems development, deep learning and high-performance computing. This short blog post covers <a href="http://www.lua.inf.puc-rio.br/gsoc/blog2024.html#pallene">my work</a> at Google Summer of Code 2024.</p>
                <p>Over the time period, I have contributed to <a href="https://github.com/pallene-lang/pallene">Pallene</a>, an ahead-of-Time compiled companion language to Lua used to write Lua&#39;s most performance critical code. Pallene is arguably more predictable and efficient than LuaJIT and Lua C API (benchmarks in the paper attached below). Pallene shares identical syntax as Lua enabling users to write high-performance code swiftly without worrying about API. Although, Pallene and Lua have a lot in common including runtime, Pallene lacks significantly in case of user debugging experience.</p>
                <p>As first line of work to tackle this challenge, our goal in <a href="https://summerofcode.withgoogle.com/programs/2024/projects/L0tirNFw">this project</a> was to introduce proper stack-trace support upon error by tracking function calls during runtime enhancing overall debugging experience in Pallene. But the Lua call-stack lacks the feature of storing line number information for Lua-to-C calls and is completely agnostic to both inter- and intra-module C-to-C calls. It also affects Pallene which eventually transpiles to C.</p>
                <p>To address the problem not only for Pallene but also for broader Lua C modules, a separate project was introduced, <a href="https://github.com/pallene-lang/pallene-tracer">Pallene Tracer</a>. Pallene Tracer provides tools, protocols and mechanisms to enable function tracebacks, generating a proper stack-trace with all the C-to-C call-frames and respective line numbers, without touching the Lua source code. Hence, over the course of summer we worked on Pallene Tracer, adoption of Pallene Tracer in Pallene and other Lua C libraries.</p>
                <p>You can learn more about Pallene in <a href="https://www.inf.puc-rio.br/~hgualandi/papers/Gualandi-2020-SCP.pdf">this paper</a>, written by my Mentor <a href="https://www.inf.puc-rio.br/~hgualandi/">Hugo Musso Gualandi</a>.</p>

                <h2 id="get-the-code">Get the Code</h2>
                <p>A good amount of code was written as part of this project for both Pallene and Pallene Tracer regarding function traceback and generating nice stack-trace during summer period.</p>
                <p>My,<br>
                Merged PRs in Pallene can be found <a href="https://github.com/pallene-lang/pallene/pulls?q=is%3Apr+is%3Aclosed+author%3Asingul4ri7y+created%3A%3E2024-05-27+merged%3A%3C2024-08-20">here</a>.<br>
                Merged PRs in Pallene Tracer can be found <a href="https://github.com/pallene-lang/pallene-tracer/pulls?q=is%3Apr+is%3Aclosed+author%3Asingul4ri7y+created%3A%3E2024-05-27+merged%3A%3C2024-08-20">here</a>.</p>
                <p>An amazing fact I enjoyed about working in this project is the collaboration between student and mentors. Coming up with a separate project like Pallene Tracer to deliver the tools, mechanisms and protocols used in Pallene to other Lua C modules was out of our idea list. But we did it regardless, just thinking about thousands of Lua C modules getting benefited from it!</p>
                <p>Hence, my mentor Hugo and I both worked in Pallene Tracer together üî•! You can find Hugo&#39;s merged PRs <a href="https://github.com/pallene-lang/pallene-tracer/pulls?q=is%3Apr+is%3Aclosed+author%3Ahugomg+created%3A%3E2024-05-27+merged%3A%3C2024-08-20">here</a>.</p>

                <h2 id="my-mentors">My Mentors</h2>
                <p>In this project, I was lucky enough to have <a href="https://www.inf.puc-rio.br/~hgualandi/">Hugo Musso Gualandi</a> as my mentor, <a href="https://injuly.in/">Srijan Paul</a> and <a href="https://www.linkedin.com/in/gabriel-ligneul">Gabriel de Quadros Ligneul</a> as co-mentors. They are just amazing. Period.</p>

                <h2 id="the-pallene-tracer">The Pallene Tracer</h2>
                <p>For comprehensive technical overview and learn how Pallene Tracer works, please refer to the <a href="https://github.com/pallene-lang/pallene-tracer/blob/docs/docs/MANUAL.md">documentation</a>.</p>
                <p>As aforementioned, Lua call-stack does not store line number information for Lua-to-C calls and is completely oblivious to C-to-C calls. Changing Lua source code to implement those features was not an option, so we decided to create a call-stack ourselves storing the relevant information. We call it the Pallene Tracer call-stack.</p>
                <p>At start, we decided to take the Linked List stack implementation route for Pallene Tracer call-stack, where we stored each frame structure in C stack memory and link between the call-frames. This approach was neat and didn&#39;t require any separate buffer allocation. <b>But</b>, there was a fundamental flaw in our idea.</p>
                <p>While using Pallene Tracer you are expected to utilize macros. A macro to push a call-frame into Pallene Tracer call-stack used at the beginning of the function, a macro to set line number information to the topmost call-frame and finally another macro to pop frame out of the stack when we exit the function execution. we call it <code>FRAMEENTER</code>, <code>SETLINE</code> and <code>FRAMEEXIT</code> macros respectively. In order for a function to be traced, it must create a frame in call-stack by calling FRAMEENTER macro and remove the frame from the call-stack by calling FRAMEEXIT macro. A function will only appear in stack-trace when respective call-frame is in the call-stack. In most cases, calling FRAMEENTER is generally safe because no runtime error is invoked as it&#39;s called at the very beginning of the function. But same cannot be said for respective FRAMEEXIT because when runtime error occurs, function execution terminates prior reaching FRAMEEXIT. This causes stack corruption and memory bugs for Linked List stack approach specifically. This is generally not a problem since Lua interpreter exits right after the error. But it is a problem, when the error is caught by <code>pcall()</code> and its variants and interpreter continues. This bug has been mentioned in this <a href="https://github.com/pallene-lang/pallene/issues/604">issue</a>.</p>
                <p>To solve the problem, the first approach was to switch to more buffer-like stack, e.g. heap allocated stack. That did fix the memory errors but the stack corruption remained because of insufficient FRAMEEXITs. To fix that problem we exploited the property of To-be-Closed Objects with <code>__close</code> metamethod. To learn more about how it was implemented, please refer to <a href="https://github.com/pallene-lang/pallene-tracer/blob/docs/docs/MANUAL.md#24-significance-of-to-be-closed-finalizer-object">the finalizer object</a> section of documentation.</p>
                <p>Accumulating frames into a separate stack is useless if don&#39;t figure a way out to print it. The builtin Lua traceback function is incapable of taking advantage of the separate call-stack we have. That&#39;s why we had to come up with our separate debug traceback function which use both of the call-stacks (our call-stack and Lua call-stack), generating a reasonable stack-trace. Our debug traceback function is the default traceback for custom Pallene Tracer Lua frontend, <a href="https://github.com/pallene-lang/pallene-tracer/blob/docs/docs/MANUAL.md#26-the-pallene-tracer-lua-frontend"><code>pt-lua</code></a>. An error handler function is also provided as a Lua global, <code>pallene_tracer_errhandler</code> to use the custom traceback function against <code>xpcall()</code> and its variants.</p>
                <p>To know more about how Pallene Tracer is implemented, please refer to <a href="https://github.com/pallene-lang/pallene-tracer/blob/docs/docs/MANUAL.md#2-implementation">implementation</a> section of the documentation.</p>

                <h2 id="enabling-tracebacks-in-pallene">Enabling Tracebacks in Pallene</h2>
                <p>To enable tracebacks in Pallene, simple pass the <code>--use-traceback</code> flag while compiling a Pallene translation.</p>
                <pre><code class="code-block">pallenec some.pln --use-traceback</code></pre>
                <p>This will enable tracing across all the Pallene functions. To use the traced function to generate a proper stack-trace in case of runtime errors, simply run the Lua script using Pallene module with our custom Lua frontend:</p>
                <pre><code class="code-block">pt-lua main.lua args ...</code></pre>
                <p>To learn more about how Pallene Tracer was adopted into Pallene, please refer to the <a href="https://github.com/pallene-lang/pallene/blob/master/doc/traceback.md">traceback documentation</a> of Pallene.</p>

                <h2 id="using-pt">Using Pallene Tracer in Lua C Libraries</h2>
                <p>TODO.</p>

                <h2 id="future-expectations">Future Expectations</h2>
                <p>Even though we have put a lot of work in Pallene Tracer and it&#39;s adoption to Pallene, there are still a lot of work to be done here. As we aim to make Pallene Tracer reachable to more Lua C library hackers, we have to come up with more generalized macros, making it more developer friendly.</p>
                <p>Pallene Tracer is in very early stage of development, a lot of bugs may still lingering around that we are unaware of. We aim to fix these bugs if appears and improve Pallene Tracer as time goes by.</p>

                <h2 id="epilogue">Epilogue</h2>
                <p>At the end of this journey, I am really glad and proud that I got to work with a real-world open-source project learning a ton of things from my mentor. I also got the chance to collaborate with my mentors, continuously discussing and implementing code and working side-by-side to make a difference in the community.</p>
                <p><a href="http://www.lua.inf.puc-rio.br/">LabLua</a> is an amazing organization. I would recommend my organization to anyone who is starting out GSoC. I would also like to do mentorship from behalf of LabLua someday.</p>
                <p>Finally, at the end of the day, I absolutely adored my GSoC journey ‚ù§Ô∏è. Peace üòá.</p>
            </div>
        </main>

        <footer class="footer">
            <p>Made with ‚ù§Ô∏è  by @singul4ri7y</p>
        </footer>
    </content>

    <script>
        const body = document.querySelector("body");
        const theme_switcher = document.querySelector("#switch");

        // Check preffered theme
        const preferred_dark = window.matchMedia("(prefers-color-scheme: dark)").matches;
        theme_switcher.checked = preferred_dark;
        body.className = preferred_dark ? "dark" : "light";

        theme_switcher.oninput = () => {
            body.className = theme_switcher.checked ? "dark" : "light";
        };
    </script>
</body>
</html>

